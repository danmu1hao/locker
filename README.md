# 本社扉のスマートキー開錠システム 基本設計書

## 更新履歴
| バージョン | 更新日 | 更新内容 | 更新者 |
|------------|------------|----------------|------------|
| 0.1        | 2025/6/10  |初版作成         |リュウホウキョウ|


## 1. 概要
### **目的：**
交通系ICカードやスマートフォンのICを用いて、本社扉の施錠・開錠を安全かつ効率的に管理する。操作履歴の記録によるセキュリティ向上。

### **対象：**
本社出入口に設置されたスマートキー管理システム。

### **主要機能：**
 1. 管理用PCにICカード／スマートフォンのIC情報を登録
 2. NFCリーダーで登録済みICの認証を実施
 3. 認証成功時にWi-Fi経由でSesameに開錠指示を送信し、一定時間後に自動施錠(未定、頻繫にロックすると逆に使いづらいかもしれない)




## 2. システム構成
### 2.1 ハードウェア構成
- ICカードリーダー(PaSoRi RC-S300)
- スマートキー(SESAMI5)
- 延長台座
- WiFiモジュール(スマートキー用の中継器)
- 管理用PC(Windows PC)
- ドアハンドル

### 2.2 ソフトウェア構成
- NFC読み取りプログラム（Python）
- カードデータの管理用データベース（SQLite）
- ICカード管理システム（Python GUIアプリ）

## 3. 機能一覧
### 3.1 **SESAMI55との通信**   
   1. Wi-Fiモジュールを介した開錠/施錠コマンドの送信   
   2. Sesame APIを利用したステータス取得・操作   
   3. 一定時間後自動施錠(未定、頻繫にロックすると逆に使いづらいかもしれない)

### 3.2 **ログ管理**   
   1. 操作ログ
   - 開錠・施錠の日時/状態
   - 操作ユーザ（カードID紐付け）
   2. デバイス状態ログ
   - バッテリー残量
   3. システムログ
   - Sesame APIの通信エラー
   - アプリケーション例外（クラッシュ等）
   - カードリーダー異常

### 3.3 **電池容量の監視**  
   1. Sesame 5のバッテリー残量を定期監視  
   2. 残量低下時に自動メール通知  

### 3.4 **カード管理（NFC）**  
   1. 登録済みICカード情報の一覧表示・管理  
   2. ICカードの新規登録および削除機能  

### 3.5 **認証機能（NFC）**  
   1. NFCリーダーでICカードを読み取り、登録情報と照合  
   2. 認証成功時にSesame5の開錠コマンドを実行




## 4. データ構成

### 4.1 ファイル管理
- TODO まだ確定していないのでまず残る
### 4.2 access_logsテーブル
| カラム名 | データ型 | 説明 |
|------------|------------|------------|
| id | INTEGER | 一意の識別子（主キー） |
| user_id | INTEGER | ユーザーID（usersテーブル外部キー） |
| timestamp | TEXT | 打刻時間（ISO8601またはUNIXタイムスタンプ） |
| card_id | TEXT | カードID |

### 4.3 usersテーブル
| カラム名 | データ型 | 説明 |
|------------|------------|------------|
| id | INTEGER | 一意の識別子（主キー） |
| name | TEXT | ユーザー名 |
| role | TEXT | 権限（admin/manager/user等） |
| card_id  | TEXT    | カードID |
| card_name | TEXT    | カード表示名（例: 山田太郎_suica） |
| register_date  | TEXT | 登録日時（YYYY-MM-DD HH:MM:SS） |

### 4.4 attendance_summaryテーブル
| カラム名 | データ型 | 説明 |
|------------|------------|------------|
| user_id | INTEGER | ユーザーID（usersテーブル外部キー、複合主キー） |
| user_name | TEXT | ユーザー名 |
| work_date | TEXT | 勤務日（YYYY-MM-DD、複合主キー） |
| earliest_time | TEXT | 最早打刻時間（HH:MM:SS） |
| latest_time | TEXT | 最遅打刻時間（HH:MM:SS） |

## 5. システム運用
- ユーザーマニュアル  
   ユーザーマニュアルでは、ユーザー登録、削除、管理を実現した。
   

## 6. 参考
- [SESAME5 API](https://doc.candyhouse.co/ja/SesameAPI)  
- [SESAME5使い方](https://note.com/xh_ichikawa/n/nd5ceb0b60cfe)
- [PaSoRi RC-S300をPythonで扱う](https://qiita.com/tomo_9180/items/5305a888e373416af5d2)
- [PythonGUI](https://qiita.com/run1000dori/items/61dc715ddaad54505a29)


